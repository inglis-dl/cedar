{##
 # test_entry_confirmation_adjudicate.twig
 #
 # Adjudicate a confirmation type test.
 # @author Dean Inglis <inglisd@mcmaster.ca>
 # @see base_view.twig for parameters
 #}
{% extends "widget.twig" %}

{% block javascript %}

  {{ parent() }}

  <script type="text/javascript">

    var table_selector = "#{{ widget.full }}__adjudicate_table";

    function configure_ui() {
      var disable_submit = false;
      var has_non_status_fields =
        0 < $( table_selector + ' div.radio__adjudicate' ).length;
      var has_status_fields =
        0 < $( table_selector + ' select[id$="adjudicate"]' ).length;

      if( has_non_status_fields ) {
        disable_submit =
          0 == $( table_selector + ' div.radio__adjudicate input:radio:checked' ).length;

        if( has_status_fields ) {
          var disable_non_status_fields = false;
          $( table_selector + ' select[id$="status__adjudicate"]' ).each( function() {
            var state = $(this).val();
            if( state == "unavailable" || state == "unusable" || state == "refused" ) {
              disable_non_status_fields = true;
              disable_submit = false;
              return false;
            }
          } );
          if( disable_non_status_fields ) {
            $( table_selector + ' div.radio__adjudicate input:radio' ).prop( "disabled", true );
            $( table_selector + ' input:radio[value="accept"]' ).prop( "disabled", true );
          }
        }
      }

      $( "#{{ parent.full }}_submit" ).button( { disabled : disable_submit } );
    }

    $( function () {

      configure_ui();

      //hijack all the non-accept radio buttons so that
      //a non-greyed out appearance can be maintained instead
      //of assigning the disabled attribute
      $( table_selector + ' div.radio__source, div.radio__adjudicate' ).click( function( e ) {
        e.preventDefault();
        return false;
      } );

      $( table_selector + ' input:radio[value="accept"]' ).change( function() {
        // get the progenitor column's data
        var id = $(this).prop( "id" ).split( "__" )[0];
        var confirmation = $( table_selector + ' input:radio[name="' + id + '"]:checked' ).val();

        // push the edit
        var columns = new Object();
        columns['confirmation'] = undefined == confirmation ? '' : confirmation;
        var args = new Object();
        args.id = $(this).prop( "name" );
        args.columns = columns;
        if( ajax_push( "{{ widget.subject }}", "edit", args ) ) {
          $( table_selector + ' input:radio[name="adjudicate"]' ).removeProp( "checked" );
          $( table_selector + ' input:radio[name="adjudicate"][value="' +
            confirmation +'"]' ).prop( "checked", true );
          configure_ui();
        }
      } );// end confirmation radio input change

      $( table_selector + ' input:radio[id$="__status__accept"]' ).change( function() {
        $source_select = $( table_selector +
          ' [id="' + $(this).prop( "id" ).replace( "__accept", "" ) + '"]' );
        var id = $(this).prop( "name" ).split( "__" )[0];
        var type = $(this).prop( "name" ).split( "__" )[1];
        var state = $source_select.val();
        var columns = new Object();
        columns[ type + '_status' ] = 'NULL' == state ? '' : state;
        var args = new Object();
        args.id = id;
        args.columns = columns;
        if( ajax_push( "{{ parent.subject }}", "edit", args ) ) {
          $target_select = $( table_selector +
            ' [id="' + $(this).prop( "name" ).replace( "accept", "adjudicate" ) + '"]' );
          $target_select.val( $source_select.val() );
          slot_refresh( {{ slot }} );
        }
      } );// end status radio input change

      $( table_selector + ' [id$="__status__adjudicate"]').change( function() {
        var id = $(this).prop( "id" ).split( "__" )[0];
        var type = $(this).prop( "id" ).split( "__" )[1];
        var state = $(this).val();
        var columns = new Object();
        columns[ type + '_status' ] = 'NULL' == state ? '' : state;
        var args = new Object();
        args.id = id;
        args.columns = columns;
        if( ajax_push( "{{ parent.subject }}", "edit", args ) ) {
          $( table_selector +
             ' input:radio[id$="' + type + '__status__accept"]' ).prop( 'checked', false );
          slot_refresh( {{ slot }} );
        }
      } ); // end adjudicate select change

    } );
  </script>

{% endblock javascript %}

{% block widget %}

  <div class="spacer"></div>
  <caption style="text-align: left;"><strong>{{ instruction }}</strong></caption>
  <div class="spacer"></div>
  <div id="{{ widget.full }}__adjudicate_table">
    <table>
      <thead>
        <tr style="height:40px">
        <td></td>
        <th colspan="3">{{ user_1 }}</th>
        <th colspan="3">{{ user_2 }}</th>
        <th colspan="2">Adjudication</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="heading">Confirmation</td>
          <td>
            <div class="radio__source">
              <input type="radio"
                id="{{ entry_data.id_1 }}__yes"
                name="{{ entry_data.id_1 }}"
                value="1"
                {{ entry_data.confirmation_1 == '1' ? "checked" : "" }}/>
              <label for="{{ entry_data.id_1 }}__yes">Yes</label>
            </div>
          </td>
          <td>
            <div class="radio__source">
              <input type="radio"
                id="{{ entry_data.id_1 }}__no"
                name="{{ entry_data.id_1 }}"
                value="0"
                {{ entry_data.confirmation_1 == '0' ? "checked" : "" }}/>
              <label for="{{ entry_data.id_1 }}__no">No</label>
            </div>
          </td>
          {% if entry_data.adjudicate|default(false) %}
            <td bgcolor=#B1F3B1>
              <div class="radio__accept">
                <input type="radio"
                  id="{{ entry_data.id_1 }}__accept"
                  name="{{ entry_data.id_3 }}"
                  value="accept"/>
                <label for="{{ entry_data.id_1 }}__accept">Accept</label>
              </div>
            </td>
          {% else %}
            <td></td>
          {% endif %}
          <td>
            <div class="radio__source">
              <input type="radio"
                id="{{ entry_data.id_2 }}__yes"
                name="{{ entry_data.id_2 }}"
                value="1"
                {{ entry_data.confirmation_2 == '1' ? "checked" : "" }}/>
              <label for="{{ entry_data.id_2 }}__yes">Yes</label>
            </div>
          </td>
          <td>
            <div class="radio__source">
              <input type="radio"
                id="{{ entry_data.id_2 }}__no"
                name="{{ entry_data.id_2 }}"
                value="0"
                {{ entry_data.confirmation_2 == '0' ? "checked" : "" }}/>
              <label for="{{ entry_data.id_2 }}__no">No</label>
            </div>
          </td>
          {% if entry_data.adjudicate|default(false) %}
            <td bgcolor=#B1F3B1>
              <div class="radio__accept">
                <input type="radio"
                  id="{{ entry_data.id_2 }}__accept"
                  name="{{ entry_data.id_3 }}"
                  value="accept"/>
                <label for="{{ entry_data.id_2 }}__accept">Accept</label>
              </div>
            </td>
            <td>
              <div class="radio__adjudicate">
                <input type="radio"
                  id="{{ entry_data.id_3 }}__yes"
                  name="adjudicate"
                  value="1"
                  {{ entry_data.confirmation_3 == '1' ? "checked" : "" }}/>
                <label for="{{ entry_data.id_3 }}__yes">Yes</label>
              </div>
            </td>
            <td>
              <div class="radio__adjudicate">
                <input type="radio"
                  id="{{ entry_data.id_3 }}__no"
                  name="adjudicate"
                  value="0"
                  {{ entry_data.confirmation_3 == '0' ? "checked" : "" }}/>
                <label for="{{ entry_data.id_3 }}__no">No</label>
              </div>
            </td>
          {% else %}
            <td></td><td colspan="2"></td>
          {% endif %}
        </tr>
        <tr style="height: 25px"><td colspan="9"></td></tr>
        {% for status in status_data %}
          <tr>
            <td class="heading">{{ status.status_label }}</td>
            <td colspan="2">
              <select id="{{ status.id_1 }}__{{ status.status_type }}__status"
                class="ui-state-default"
                style="width: 100%"
                disabled>
                {% for status_id, status_value in status.status_list %}
                  {% set status_display = status_value is defined ? status_value : "" %}
                  <option{{ status.status_1 == status_id ? ' selected' : '' }}
                   value="{{ status_id }}">{{ status_display }}</option>
                {% endfor %}
              </select>
            </td>
            {% if status.adjudicate|default(false) %}
              <td bgcolor=#B1F3B1>
                <input type="radio"
                  id="{{ status.id_1 }}__{{ status.status_type }}__status__accept"
                  name="{{ status.id_3 }}__{{ status.status_type }}__status__accept"
                  value="{{ status.status_type }}__status__accept"/>
                <label for="{{ status.id_1 }}__{{ status.status_type }}__status__accept">Accept</label>
              </td>
            {% else %}
              <td></td>
            {% endif %}
            <td colspan="2">
              <select id="{{ status.id_2 }}__{{ status.status_type }}__status"
                class="ui-state-default"
                style="width: 100%"
                disabled>
                {% for status_id, status_value in status.status_list %}
                  {% set status_display = status_value is defined ? status_value : "" %}
                  <option{{ status.status_2 == status_id ? ' selected' : '' }}
                   value="{{ status_id }}">{{ status_display }}</option>
                {% endfor %}
              </select>
            </td>
            {% if status.adjudicate|default(false) %}
              <td bgcolor=#B1F3B1>
                <input type="radio"
                  id="{{ status.id_2 }}__{{ status.status_type }}__status__accept"
                  name="{{ status.id_3 }}__{{ status.status_type }}__status__accept"
                  value="{{ status.status_type }}__status__accept"/>
                <label for="{{ status.id_2 }}__{{ status.status_type }}__status__accept">Accept</label>
              </td>
              <td colspan="2">
                <select id="{{ status.id_3 }}__{{ status.status_type }}__status__adjudicate"
                  class="ui-state-default"
                  style="width: 100%">
                  {% for status_id, status_value in status.status_list %}
                    {% set status_display = status_value is defined ? status_value : "" %}
                    <option{{ status.status_3 == status_id ? ' selected' : '' }}
                     value="{{ status_id }}">{{ status_display }}</option>
                  {% endfor %}
                </select>
              </td>
            {% else %}
              <td colspan="3"></td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

{% endblock widget %}
